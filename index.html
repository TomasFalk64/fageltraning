<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kvitterkollen</title> 
    <!-- Open Graph metadata för delning -->
    <meta property="og:title" content="Kvitterkollen – Träna fågelsång" />
    <meta property="og:description" content="Gissa vilken fågel du hör. Träna på fågelsång och lär dig känna igen svenska fågelläten." />
    <meta property="og:url" content="https://kvitterkollen.se" />
    <meta property="og:type" content="website" />
    <meta property="og:image" content="https://kvitterkollen.se/images/Dendrocopos_minor.png" />

    <!-- Twitter-kort (valfritt men bra) -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Kvitterkollen – Träna fågelsång" />
    <meta name="twitter:description" content="Lär dig fågelläten på ett roligt och pedagogiskt sätt." />
    <meta name="twitter:image" content="https://kvitterkollen.se/images/Dendrocopos_minor.png" />

    <script>
        if (location.hostname === 'www.kvitterkollen.se') {
          location.href = location.protocol + '//' + 'kvitterkollen.se' + location.pathname;
        }
    </script>

    <link rel="stylesheet" href="style.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
    <link rel="icon" href="favicon_TF.ico" type="image/x-icon">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <img 
        src="images/Dendrocopos_minor.png" 
        alt="" 
        role="presentation" 
        aria-hidden="true" 
        style="width: 1px; height: 1px; opacity: 0; position: absolute; pointer-events: none;" 
    />
    <div class="header-container">
        <h1 class="page-title">&nbsp;&nbsp;&nbsp;Träna fågelsång</h1>
        <!-- <img src="Dendrocopos minor.png" alt="Mindre hackspett" class="header-icon"> -->
    </div>
    
    <div class="container">
        <div class="filters">
            <p class="section-title">Välj arter</p>

            <details>
                <summary class="section-title-left">Inställningar</summary>

                <div><input type="checkbox" id="includeConfusion" class="custom-checkbox" /> Inkludera förväxlingsarter</div>
                <div><input type="checkbox" id="excludeSure" class="custom-checkbox" /> Undvik arter du redan kan</div>
                <div> 
                    <div style="margin-top: 30px;"></div>  <!-- Extra utrymme -->
                    <div>
                        <div id="soundTags" style="display: flex; flex-wrap: wrap; align-items: center; gap: 8px;">
                        <button class="tag-button selected" data-type="song">
                            <span class="checkmark">✓</span> Sång <span class="filler">&nbsp;</span>
                        </button>
                        <button class="tag-button" data-type="alarm call">
                            <span class="checkmark">✓</span> Varningsläte <span class="filler">&nbsp;</span>
                        </button>
                        <button class="tag-button" data-type="call">
                            <span class="checkmark">✓</span> Kontaktläte <span class="filler">&nbsp;</span>
                        </button>
                        <button class="tag-button" data-type="flight call">
                            <span class="checkmark">✓</span> Flyktläte <span class="filler">&nbsp;</span>
                        </button>
                        <button class="tag-button" data-type="drumming">
                            <span class="checkmark">✓</span> Trumning <span class="filler">&nbsp;</span>
                        </button>
                    
                        
                        <div style="width: 30px;"></div>  <!--  mellanrum efter sista knappen -->
                            <span class="songTooltip">
                                <i class="fas fa-info-circle info-icon" onclick="showInfoAlert()"></i>
                                <span class="songTooltiptext">
                                    Välj sång om du vill slippa korta varningsläten etc.<br>
                                    Trumning kan vara ett bra val för hackspettar.<br>
                                    Observera att vissa fåglar inte har sångläten.
                                    <span class="tooltipArrow"></span>
                                </span>
                            </span>
                        </div>
                    </div>
                </div>
            </details>

            <div style="display: flex; align-items: flex-end; margin-top: 30px;">
                
                <input type="text"
                    id="speciesInput"
                    placeholder="Sök arter att träna på"
                    title="Skriv t.ex. gråsparv, sparv, sparvar, passer eller skog"
                    style="flex: 1;">

                    <button id="resetButton" title="Återställ" class="image-button">
                    <img src="forsarla_reset.png" alt="Återställ" class="forsarla-icon">
                </button>
            </div>

            <input type="text" name="email_check" style="display: none;"> <!-- honeypot -->
                       
            <div><p id="trainList"></p></div>
        </div>

        <div class="mitt">
            <p class="section-title">Träning</p>
            <div><audio id="audioPlayer" controls></audio></div> 
           
            <div id="trainButtons" style="display: flex; justify-content: center; align-items: center; gap: 10px; margin-top: 20px;">
                <button id="playButton" onclick="playRandomBird()" class="button" >Träna på nytt läte</button>
                <span id="loadingStatus" style="font-size: 1em;"></span>
            </div>

            <div id="clueButtons" style="margin-top: 30px;">
                <button id="clueButton" onclick="showClue()" class="button" >Ledtråd</button>
            </div>
            <div>
                <p id="clueText"></p> <!-- Visar ledtråden -->
                <input type="text" id="customClueInput" placeholder="Skriv en egen ledtråd..." style="display:none;">
            </div>
            <div id="guessResult" class="guess-result" style="margin-top: 20px;"></div>
      
            <div id="speciesImage" style="margin-top: 10px;"></div>
            
            <div id="resultSpecies" class="result-species"></div>

            <div id="guessing" style="display: flex; align-items: flex-end; gap: 8px; margin-top: 5px;">
                <input type="text" id="guessInput"
                    onkeyup="dropDown()"
                    placeholder="Klicka i listan för att gissa"
                    title="Skriv ett namn"
                    style="flex: 1; height: 22px; font-size: 13px; padding: 3px 6px;">   
                              
                <button id="resetGuessButton" class="image-button" title="Rensa gissningslista">
                    <img src="bofink_reset.png" alt="Reset" class="bofink-icon">
                </button>
                  <!-- <i class="fas fa-sync-alt"></i> -->
                
            </div>

            <div style="margin-top: 5px;"></div>
            <ul id="guessUL"></ul> <!-- Dynamisk lista -->
        </div>

        <div class="statistics">
            <!-- <p class="section-title" style="margin-bottom: 10px;">Statistik</p> -->
            <div style="position: relative;">
                <p class="section-title" style="margin-bottom: 10px;">Statistik</p>
                <img src="Dendrocopos_minor_right.png" alt="Statistikikon" style="position: absolute; right: 0; top: 0; height: 45px;">
            </div>

            <div id="resultBar" style="margin-top: 10px; font-size: 0.9em;"></div>
 
             <canvas id="progressChart" width="300" height="150" style="margin-top: 20px;"></canvas>
          
            <div id="groupStats" style="margin-top: 30px;"></div>
            

            <details style="margin-top: 50px;">
                <summary class="section-title-left">Hämta eller spara din data</summary>
                <div style="margin-top: 10px;">
                  <input type="file" id="uploadFileInput" accept=".json" />
                </div>
                <div style="margin-top: 20px;">
                  <button onclick="downloadBirdFacts()" class="button">Spara till dator</button>
                </div>
            </details>  
            
            <div style="margin-top: 10px; text-align: center;">
                <button onclick="showInfoAlert()" class="info-button"><i class="fas fa-question"></i></button>
            </div>
            
        </div>
    </div>

    <div id="customAlert" class="custom-alert" style="display: none;">
        <span id="customAlertText"></span>
        <button  onclick="hideCustomAlert()">OK</button>
    </div>

    <footer style="text-align: center; margin-top: 40px; font-size: 0.85em; opacity: 0.7;">
        <a href="https://www.freecounterstat.com" target="_blank" title="Page counter">
          <img src="https://counter4.optistats.ovh/private/freecounterstat.php?c=nkcezkqp3d8nx5scumkwlsas73l7htgp" border="0" alt="Page counter" />
        </a>
    </footer>

    <script>
        let searchHistory = [];

        let currentSpecies = ""; // aktuell art , Latinskt namn
        let currentSpeciesSex = "";
        let nbTries = 0;
        let nbCorrect = 0;
        let streakCount= 0;
        let avbrutenLjudsökning = false;
        let guessLocked = false;
        let guessHistory = []; // 1 eller 0 för varje gissning
        
        let birdFacts = {};
        let artgrupper = {};
        let trainList = [];
        let guessList = [];
        let birdImageList = [];
        let birdMetadata = {};

        const soundCache = {};
        const soundCacheOrder = [];
        const maxCacheSize = 20;
        const maxGuessHistory = 20;

        let progressChart;
        let accuracyData = [];
        let attemptLabels = [];

        async function loadBirdImages() {
            const response = await fetch('birdImages.json');
            birdImageList = await response.json();
        }

        // async function loadBirdFacts() {
        //     const response = await fetch('birdFacts.json'); 
        //     const temp = await response.json();
        //     birdFacts = temp;
        // }
        
         async function loadArtgrupper() {
            const response = await fetch('artgrupper.json'); 
            artgrupper = await response.json(); 
        }

        async function loadbirdMetadata() {
            const response = await fetch('metadata.json'); 
            birdMetadata = await response.json(); 
        }

        function validateBirdFacts(temp) {
            const validated = {};
            let count = 0;

            for (const key in temp) {
                const art = temp[key];
                const isValid =
                    typeof art.name === "string" &&
                    typeof art.nbTries === "number" &&
                    typeof art.nbCorrect === "number" &&
                    Array.isArray(art.confusionSpecies);

                if (isValid) {
                    validated[key] = art;
                    count++;
                } else {
                    console.warn(`⚠️ Ogiltig artdata för "${key}" – hoppar över`);
                }
            }

            return { validated, count };
        }


        async function loadBirdFacts() {
            try {
                const response = await fetch('birdFacts.json');
                const temp = await response.json();

                if (typeof temp !== 'object' || Object.keys(temp).length === 0) {
                    throw new Error("❌ JSON verkar inte innehålla artdata.");
                }

                const { validated, count } = validateBirdFacts(temp);
                birdFacts = validated;
                console.log(`Laddade in ${count} arter från birdFacts.json`);

            } catch (error) {
                console.error("🚫 Fel vid inläsning av birdFacts.json:", error);
                showCustomAlert("Fel vid inläsning av fågeldata. Kontrollera filens format.");
            }
        }

        async function init() {
            await Promise.all([
                loadBirdFacts(),
                loadArtgrupper(),
                loadBirdImages(),
                loadbirdMetadata(),
                visaArtgruppStatistik()
            ]);
            console.log("BirdFacts:", birdFacts);
            console.log("Artgrupper:", artgrupper);

            resetLists();
            uppdateraTräningsknappar();
            document.getElementById("speciesInput").focus();
        }

        init();


        document.getElementById("resetButton").addEventListener("click", resetLists); //Reset
        document.getElementById("resetGuessButton").addEventListener("click", resetGuessList);

        document.addEventListener("DOMContentLoaded", function () {
            // Klick på art i listan
            document.getElementById("guessUL").addEventListener("click", function (e) {
                if (e.target && e.target.tagName === "A") {
                    e.preventDefault();
                    const selectedGuess = e.target.textContent;
                    document.getElementById("guessInput").value = selectedGuess;
                }
            });

            // Enter = välj automatiskt om bara ett alternativ syns
            document.getElementById("guessInput").addEventListener("keydown", function (event) {
                if (event.key === "Enter") {
                    const visibleItems = Array.from(document.querySelectorAll("#guessUL li"))
                        .filter(li => li.style.display !== "none");

                    if (visibleItems.length === 1) {
                        visibleItems[0].querySelector("a")?.click(); // Simulera klick på länken i listan
                        event.preventDefault(); // Förhindra annan Enter-beteende
                    }
                }
            });
        });
        
        document.getElementById("speciesInput").addEventListener("keydown", function(event) {
            if (event.key === "Enter") {  // Kollar om användaren trycker på Enter i ändra träningslista
                event.preventDefault();
                findTrainList();
            }
        });

        document.getElementById('customClueInput').addEventListener('keydown', function(event) {
            if (event.key === 'Enter') {  // Kollar om användaren trycker på Enter i Ledtråd
                updateClue(); 
            }
        });

        document.getElementById("uploadFileInput").addEventListener("change", function () {
            loadBirdFactsFromFile(); // Ladda filen direkt när den väljs
        });

        document.querySelectorAll('#soundTags .tag-button').forEach(btn => {
            btn.addEventListener('click', () => {
                btn.classList.toggle('selected');
            });
        });


        function resetLists() {
            trainList = [];
            guessList = [];
            document.getElementById("speciesInput").value = "";
            document.getElementById("trainList").innerHTML = "";
            document.getElementById("guessResult").textContent = "";
            document.getElementById("guessResult").className = "guess-result";
            document.getElementById("clueText").textContent = "";
            document.getElementById("customClueInput").style.display = "none";
            document.getElementById("guessInput").value = "";
            document.getElementById("speciesImage").innerHTML = "";
            document.getElementById("resultSpecies").textContent = "";
            document.getElementById("loadingStatus").innerHTML = "";
            document.getElementById("audioPlayer").src = ""; 

            nbTries = 0;
            nbCorrect = 0;
            avbrutenLjudsökning = true;
            accuracyData = [];
            attemptLabels = [];
            updateChart();
            updateResultBar()
            uppdateraTräningsknappar();

            visaArtgruppStatistik();                    
            populateGuessList(); 

            document.getElementById("speciesInput").focus();
        }
                
        async function findTrainList() {
            const query = document.getElementById('speciesInput').value.toLowerCase().trim();
            trackSearch(query);
            const listDiv = document.getElementById('trainList');
            const includeConfusionCheckbox = document.getElementById("includeConfusion");
            let artgrupphittad = false;

            listDiv.innerHTML = ""; // Rensa tidigare resultat
            trainList = [];  

            if (!await shouldAllowSearch(query)) return;
            

            if (!birdFacts || Object.keys(birdFacts).length === 0) {
                console.error("❌ birdFacts är inte laddad eller tom!");
                return;
            }

            const normalize = str => str.trim().toLowerCase().replace(/\s+/g, ' ');
            const foundKey = Object.keys(artgrupper).find(key => normalize(key) === normalize(query));            

            if (foundKey) {
                const speciesList = artgrupper[foundKey]; // Lista med svenska artnamn

                for (const swedishName of speciesList) {
                    // Slå upp latinskt namn via birdFacts
                    const latinName = Object.keys(birdFacts).find(
                        key => birdFacts[key].name === swedishName
                    );

                    if (latinName) {
                        trainList.push({ latin: latinName, swedish: swedishName });
                    } else {
                        console.warn(`⚠️ Hittade inte latinskt namn för: ${swedishName}`);
                    }
                }

                artgrupphittad = true;
            }


            if (!artgrupphittad) {
                        // Gå igenom birdFacts och leta efter matchning
                for (const latinName in birdFacts) {
                    if (!birdFacts[latinName] || !birdFacts[latinName].name) {
                        console.warn(`⚠️ Saknad 'name' för: ${latinName}`);
                        continue;  // Hoppa över om det saknas
                    }

                    const swedishName = birdFacts[latinName].name.toLowerCase();
                    const latinNameLower = latinName.toLowerCase();

                    if (latinNameLower.includes(query) || swedishName.includes(query)) {
                        trainList.push({ latin: latinName, swedish: birdFacts[latinName].name });
                    }
                }
            }
                            
            if (includeConfusionCheckbox.checked) {  // Lägg till förväxlingsarter
                    const confusionSpecies = new Set();

                    trainList.forEach(species => {
                        const confusionList = birdFacts[species.latin]?.confusionSpecies;
                        if (confusionList && Array.isArray(confusionList)) {
                            confusionList.forEach(confusionLatin => {
                                if (!trainList.some(s => s.latin === confusionLatin) && birdFacts[confusionLatin]) {
                                    confusionSpecies.add(confusionLatin);
                                }
                            });
                        }
                    });

                    // Lägg till de nya förväxlingsarterna i trainList
                    confusionSpecies.forEach(latinName => {
                        trainList.push({ latin: latinName, swedish: birdFacts[latinName].name });
                    });
                }

            if (trainList.length === 0) {
                listDiv.innerHTML = "<p>Inga matchningar hittades.</p>";
                return;
            }

           // Skapa en lista med checkboxes
            const excludeSureCheckbox = document.getElementById("excludeSure");
            const form = document.createElement("form");
            form.id = "trainListForm";

            trainList.forEach(species => {
                const label = document.createElement("label");
                label.style.display = "block";

                const checkbox = document.createElement("input");
                checkbox.type = "checkbox";
                checkbox.value = species.latin;
                checkbox.checked = true;
                checkbox.className = "custom-checkbox";

                label.appendChild(checkbox);

                label.innerHTML += ` ${species.swedish} <i style="font-size: 0.8em;">${species.latin}</i>`;
                label.style.fontSize = "0.9em"; // Svenska textens storlek

                form.appendChild(label);
            });

            listDiv.appendChild(form);

            setTimeout(() => {
                document.querySelectorAll("#trainListForm input[type=checkbox]").forEach(checkbox => {
                    const species = trainList.find(s => s.latin === checkbox.value); // Hitta arten
                    
                    if (species && excludeSureCheckbox.checked && birdFacts[species.latin]?.nbTries > 0) {
                        const nbCorr = birdFacts[species.latin].nbCorrect;
                        const nb = birdFacts[species.latin].nbTries; 
                        checkbox.checked = nbCorr < 0.5 * nb;
                    } else {
                        checkbox.checked = true;
                    }
                });
            }, 0);

            // Skapa och lägg till "Spara söklistan"-knappen
            const saveButton = document.createElement("button");
            saveButton.textContent = "Spara till träningslistan";
            saveButton.onclick = saveGuessList;
            saveButton.className = "green-button";
            saveButton.style.marginTop = "10px";
            listDiv.appendChild(saveButton);
            
        }

        async function shouldAllowSearch(query) {
            if (!query) return false;

            const honeypot = document.querySelector('input[name="email_check"]');
            if (honeypot && honeypot.value !== "") {
                console.warn("🕷️ Möjlig bot upptäckt via honeypot!");
                return false;
            }

            const now = Date.now();
            window.lastSearchTime = window.lastSearchTime || 0;

            const timeSinceLast = now - window.lastSearchTime;
            if (timeSinceLast < 1000) {
                const delay = 1000 - timeSinceLast;
                await new Promise(resolve => setTimeout(resolve, delay));
            }

            window.lastSearchTime = Date.now();
            return true;
        }



        // Sparar de icheckade arterna i guessList
        function saveGuessList() {
            
            const checkboxes = document.querySelectorAll("#trainListForm input[type='checkbox']:checked");

            checkboxes.forEach(checkbox => {
                if (!guessList.includes(checkbox.value)) {  // Kontrollera om arten redan finns
                    guessList.push(checkbox.value);
                }
            });

            document.getElementById("speciesInput").value = "";
            populateGuessList();
            uppdateraTräningsknappar();
            updateResultBar()
        }

        async function playRandomBird() {
            document.getElementById("guessResult").textContent = "";
            document.getElementById("guessResult").className = "guess-result";
            document.getElementById('clueText').textContent = ""; 
            document.getElementById('customClueInput').style.display = "none"; 
            document.getElementById('guessInput').value = ""
            document.getElementById('speciesImage').innerHTML = "";
            document.getElementById('resultSpecies').textContent = "";
            guessLocked = false;
            
            if (!guessList || guessList.length === 0) { 
                showCustomAlert("Välj arter att träna på &nbsp;")
                return; 
            }
            document.getElementById("loadingStatus").innerHTML = `<span class="spinner"></span>`;
            
            
            currentSpecies = guessList[Math.floor(Math.random() * guessList.length)]; // Ex: "Parus major"
           

            try {
                avbrutenLjudsökning = false;
                
                const selectedTypes = getSelectedSoundTypes(); // t.ex. ["song", "call"]
                const randomRecording = await fetchRecording(currentSpecies, selectedTypes);
                
                if (avbrutenLjudsökning) {
                    return;
                }

                if (!randomRecording) {
                    document.getElementById("loadingStatus").innerHTML = "";
                    showCustomAlert("Inga ljudinspelningar hittades. Prova att ändra ljudtyp i Inställningar");
                    return;
                }

                currentSpeciesSex = randomRecording.sex

                document.getElementById("audioPlayer").oncanplay = () => {
                    const xcId = `XC${randomRecording.id}`;
                    const recordist = randomRecording.rec || "okänd inspelare";

                      document.getElementById("loadingStatus").innerHTML = `
                        <span title="Inspelning: ${xcId} – ${recordist}\nKlicka för att öppna i Xeno-Canto">
                            <a href="https://xeno-canto.org/${randomRecording.id}" target="_blank" style="text-decoration: none; color: inherit;">🔊</a>
                        </span>`;
                };
                // spela upp ljudet
                document.getElementById('audioPlayer').src = randomRecording.file;  // Ljudfilens URL
                document.getElementById('audioPlayer').play();
            } catch (error) {
                console.error("Fel vid hämtning av ljudfil:", error);
                document.getElementById("loadingStatus").innerHTML = `⚠️ Ingen ljudfil.`;
            }
        }

        async function fetchRecording(currentSpecies, selectedTypes = ["song"]) {
            const speciesOverride = {
                "Corvus monedula": "Coloeus monedula",
                "Loxia bifasciata": "Loxia leucoptera"
            };
            const lookupSpecies = speciesOverride[currentSpecies] || currentSpecies;
            const typeKey = selectedTypes.length > 0 ? selectedTypes.join("_") : "all";
            const cacheKey = currentSpecies + "_" + typeKey;

            if (soundCache[cacheKey]?.length > 0) {
                //console.log(`🎧 Hämtar från cache: ${cacheKey}`);
                const cached = soundCache[cacheKey];
                return cached[Math.floor(Math.random() * cached.length)];
            }

            const minAntal = 20;
            let allRecordings = [];

            function filterByTypesAndQuality(recordings, types, qualityLevels = null) {
                const typesLower = types.map(t => t.toLowerCase());

                return recordings.filter(rec => {
                    const matchesType =
                        types.length === 0 || typesLower.includes(rec.type.toLowerCase());

                    const matchesQuality =
                        !qualityLevels || qualityLevels.length === 0 || qualityLevels.includes(rec.q);

                    return matchesType && matchesQuality;
                });
            }

            // Försök hitta ljud i Norden
            const countries = ["sweden", "norway", "finland"];
            for (const country of countries) {
                const query = `${lookupSpecies}+cnt:${country}`;
                const response = await fetch(`https://xeno-canto.org/api/2/recordings?query=${query}`);
                const data = await response.json();

                if (data.recordings?.length > 0) {
                    const filtered = filterByTypesAndQuality(data.recordings, selectedTypes, ["A", "B"]);
                    //console.log( country, "Före:", data.recordings.length, "Efter filtrering:", filtered.length);
                    allRecordings = allRecordings.concat(filtered);
                } 
                if (allRecordings.length >= minAntal) break;
            }

            // Om det inte räcker, sök globalt
            if (allRecordings.length < minAntal) {
                let page = 1;
                let hasMore = true;

                while (hasMore && allRecordings.length < minAntal) {
                    const query = `${lookupSpecies}&page=${page}`;
                    const response = await fetch(`https://xeno-canto.org/api/2/recordings?query=${query}`);
                    const data = await response.json();

                    if (data.recordings?.length > 0) {
                        let filtered = filterByTypesAndQuality(data.recordings, selectedTypes, ["A", "B"]);

                        if (filtered.length < minAntal && page === 1) {
                            filtered = filterByTypesAndQuality(data.recordings, selectedTypes); // alla kvaliteter
                        }

                        allRecordings = allRecordings.concat(filtered);
                    }

                    page += 1;
                    hasMore = data.numPages && page <= data.numPages;
                }
            }

            if (allRecordings.length > 0 && soundCacheOrder.length < maxCacheSize) {
                addToSoundCache(currentSpecies, allRecordings, typeKey);
            }

            if (allRecordings.length === 0) {
                console.warn("⚠️ Inga inspelningar hittades.");
                return null;
            }

            //console.log("Resultat: ", allRecordings.length );
            const randomRecording = allRecordings[Math.floor(Math.random() * allRecordings.length)];
            return randomRecording;
        }



        function populateGuessList() {
            const ul = document.getElementById("guessUL");
            ul.innerHTML = ""; // Rensa listan

            guessList.forEach(species => {
                const li = document.createElement("li");
                const a = document.createElement("a");
                a.href = "#";
                a.textContent = birdFacts[species].name;
                a.onclick = function() {
                    showGuessResult(species,birdFacts[species].name); // Uppdatera guessResult
                };
                li.appendChild(a);
                ul.appendChild(li);
            });
        }

        function dropDown() {
            const input = document.getElementById("guessInput");
            const filter = input.value.toUpperCase();
            const ul = document.getElementById("guessUL");
            const li = ul.getElementsByTagName("li");

            for (let i = 0; i < li.length; i++) {
                const txtValue = li[i].textContent || li[i].innerText;
                li[i].style.display = txtValue.toUpperCase().includes(filter) ? "" : "none";
            }
        }


        async function showGuessResult(speciesLat, speciesSV) {

            if (guessLocked) {
                showCustomAlert("Du har redan gissat.<br>Klicka på 'Träna på nytt läte'<br>");
                return;
            };

            const resultDiv = document.getElementById("guessResult");
            const resultSpeciesDiv = document.getElementById("resultSpecies");
            const imageDiv = document.getElementById("speciesImage"); 
            let responseText;

            const isCorrect = speciesLat.toLowerCase() === currentSpecies.toLowerCase();

            if (isCorrect) {guessHistory.push(1);}
            else {guessHistory.push(0);}
            if (guessHistory.length > maxGuessHistory) guessHistory.shift(); 

            nbTries += 1;
            birdFacts[currentSpecies].nbTries += 1;

            if (isCorrect) {
                guessLocked = true;
                nbCorrect += 1;
                birdFacts[currentSpecies].nbCorrect += 1;
                streakCount += 1;

                if (streakCount === 3) {
                    responseText = "🔥 Tre rätt i rad! Du är på gång!";
                } else if (streakCount === 5) {
                    responseText = "🌟 Fem i rad! Fantastiskt!";
                } else if (streakCount === 10) {
                    responseText = "🚀 Tio rätt i rad!? Du är mästare!";
                } else {
                const correctResponses = [
                    `🍀 Rätt!`,
                    "🎯 Spot on!",
                    "🎯 Fullträff!",
                    `💚 Bra jobbat! 💚`,
                    "💚 Yes! Du tog den! 💚",
                    "💚 Bra öron – det var rätt!",
                    `🍀 Exakt!`,
                    `🍀 Helt rätt!`,
                    `🍀 Snyggt!`,
                    `🍀 Du har koll på`
                ]; 
                responseText = correctResponses[Math.floor(Math.random() * correctResponses.length)];
                }  
            } else {
                guessLocked = true;
                const incorrectResponses = [
                    `❌ Fel!`,
                    "😕 Miss. Försök igen",
                    `❌ Inte riktigt!`,
                    `❌ Fel – men nära kanske?`,
                    `🙈 Bättre lycka nästa gång!`,
                    `😬 Inte riktigt. Prova nästa!`
                ];
                responseText = incorrectResponses[Math.floor(Math.random() * incorrectResponses.length)];
                streakCount = 0;
                if (!birdFacts[currentSpecies].confusionSpecies.includes(speciesLat)) {
                    birdFacts[currentSpecies].confusionSpecies.push(speciesLat);
                    if (birdFacts[currentSpecies].confusionSpecies.length > 4) {
                        birdFacts[currentSpecies].confusionSpecies.shift(); // tar bort den äldsta förväxlingsarten
                    }
                }
                
            }

            updateResultBar()
            updateChart();
            visaArtgruppStatistik();
            resultDiv.textContent = responseText;
          
            await showSpeciesImage(birdFacts[currentSpecies].name);

            resultSpeciesDiv.innerHTML = `${birdFacts[currentSpecies].name} <em>${currentSpecies}</em> ${getSexSymbol(currentSpeciesSex)}`;

            document.getElementById('guessInput').value = ""
            dropDown();
        }

        async function showSpeciesImage(svName) {
            const imageDiv = document.getElementById('speciesImage');

            function normalizeName(name) {
                return name
                    .toLowerCase()
                    .replace(/[åä]/g, 'a')
                    .replace(/ö/g, 'o')
                    .replace(/[\s_0-9]+/g, '');
            }

            const normalizedSvName = normalizeName(svName);
            
            // const matchingLocal = birdImageList.filter(filename => {
            //     const nameWithoutExt = filename.replace(/\.[^/.]+$/, "");
            //     const normalizedFile = normalizeName(nameWithoutExt);
            //     return normalizedFile.includes(normalizedSvName);
            // });  
            const matchingLocal = birdImageList.filter(filename => {
                const nameWithoutExt = filename.replace(/\.[^/.]+$/, "");
                const normalizedFile = normalizeName(nameWithoutExt);

                return (
                    normalizedFile === normalizedSvName || 
                    normalizedFile.startsWith(normalizedSvName)
                );
            });         

            if (matchingLocal.length > 0) {
                const randomLocal = matchingLocal[Math.floor(Math.random() * matchingLocal.length)];
                const localUrl = `birdPicts/${randomLocal}`;

            // Hämta metadata för bilden
            const meta = birdMetadata[randomLocal];
                let titleText = "";
                if (meta) {
                    const { provider, photographer } = meta;
                    if (provider && photographer) {
                        titleText = `📷 ${provider}, ${photographer}`;
                    } else if (provider) {
                        titleText = `📷 ${provider}`;
                    } else if (photographer) {
                        titleText = `📷 ${photographer}`;
                    }
                }

                imageDiv.innerHTML = `
                    <div class="image-container">
                        <img src="${localUrl}" alt="${svName}" style="max-width: 180px; border-radius: 10px;">
                        <div class="image-meta">${titleText}</div>
                    </div>
                `;
                return;
            }

            // Visa fallback-bild, annars hämta från webben
            const localFallback = 'birdPicts/Bild_saknas.webp';

            try {
                const response = await fetch(localFallback, { method: 'HEAD' });

                if (response.ok) {
                    imageDiv.innerHTML = `<img src="${localFallback}" style="max-width: 150px; border-radius: 10px;">`;
                } else {
                    // Fallback-bild finns inte, hämta från nätet
                    const imageUrl = await fetchRandomImage(svName);

                    if (imageUrl) {
                        imageDiv.innerHTML = `<img src="${imageUrl}" alt="${svName}" style="max-width: 180px; border-radius: 10px;">`;
                    } else {
                        imageDiv.innerHTML = "<p>Ingen bild tillgänglig.</p>";
                    }
                }
            } catch (error) {
                imageDiv.innerHTML = "<p>Kunde inte ladda bilden.</p>";
            }
        }

        async function fetchRandomImage(speciesSV) {
            const API_KEY = "49566155-8922f41ce0098cddb78eed458"
            const query = encodeURIComponent(speciesSV); 
            const url = `https://pixabay.com/api/?key=${API_KEY}&q=${query}&lang=sv&image_type=photo&safesearch=true&per_page=10`;

            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error("Misslyckades med att hämta bilder från Pixabay");
                }
                
                const data = await response.json();
                
                const exactMatch = data.hits.filter(img => {
                    return img.tags.toLowerCase().split(", ").some(tag => tag.includes(speciesSV.toLowerCase()));
                });
                
                if (exactMatch.length > 0) {
                    const randomImage = exactMatch[Math.floor(Math.random() * exactMatch.length)];
                    return randomImage.previewURL; 
                } else {
                    return null;
                }
            } catch (error) {
                console.error("Fel vid hämtning av bild:", error);
                return null;
            }
        }


        async function showClue() {
            const clueText = document.getElementById('clueText');
            const customClueInput = document.getElementById('customClueInput');
            customClueInput.value = ""
            
            if (!currentSpecies) {
                // clueText.textContent = "Lägg till arter först!";
                return;
            }

            // visa ledtråd
            const speciesInfo = birdFacts[currentSpecies];
            if (speciesInfo && speciesInfo.clue) {
                clueText.textContent = speciesInfo.clue;  // Visa den lagrade ledtråden från birdFacts
            } else {
                clueText.textContent = "Ingen ledtråd tillgänglig."; 
            }
                
            customClueInput.style.display = "inline-block"; // Visa inmatningsfältet för ny ledtråd
        }

        async function updateClue() {
            const customClueInput = document.getElementById('customClueInput').value.trim();

            if (!currentSpecies || !customClueInput) { return; }

            if (birdFacts[currentSpecies]) { birdFacts[currentSpecies].clue = customClueInput; }
            document.getElementById('clueText').textContent = `Ledtråd uppdaterad: ${customClueInput}`;              
        }

        function loadBirdFactsFromFile() {
            const fileInput = document.getElementById("uploadFileInput");
            const file = fileInput.files[0]; // Hämta den valda filen

            if (!file) {
                showCustomAlert("Välj en fil först!");
                return;
            }

            const reader = new FileReader();
            reader.onload = async function (event) {
                try {
                    const parsed = JSON.parse(event.target.result); 
                    const { validated, count } = validateBirdFacts(parsed);
                    if (count === 0) {
                        showCustomAlert("Filen innehåller ingen giltig fågeldata.");
                    } else {
                        birdFacts = validated;
                        showCustomAlert(`Fågeldata har laddats in! (${count} arter)`);
                        visaArtgruppStatistik();
                    }
                } catch (error) {
                    showCustomAlert("Fel vid inläsning av JSON-filen.");
                    console.error("JSON-parse-fel:", error);
                }
            };

            reader.readAsText(file); // Läs in filen som text
        }

        function downloadBirdFacts() {
            const dataStr = JSON.stringify(birdFacts, null, 2); // Format med indrag
            const blob = new Blob([dataStr], { type: "application/json" });
            const url = URL.createObjectURL(blob);

            const link = document.createElement("a");
            link.href = url;
            link.download = "birdFacts.json";
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            URL.revokeObjectURL(url); // Rensa temporär URL
        }

        // function showInfoAlert() {
        //     showCustomAlert(
        //         "🕊️ Träna fågelsång\n\n" +
        //         "Välj ut arter\n" +
        //         "Börja i kolumnen till vänster och skriv t.ex. 'hackspett' i rutan \"Sök arter att träna på\"\n" +
        //         "Ett antal förslag visas. Du kan klicka ur dom arter du inte vill träna på\n" +
        //         "Klicka sedan på \"Spara\"-knappen\n\n" +

        //         "Träna\n" +
        //         "Börja träna genom att klicka på \"Träna på nytt läte\"\n" +
        //         "Gissa på arterna \n" +
        //         "Ledtrådar är ett bra sätt att minnas\n" +
        //         "För att börja om, klicka på återställ-knappen: ↺\n\n" +

        //         "När du hållit på ett tag kan du välja:\n" +
        //         "\"Inkludera förväxlingsarter\": Söker du t.ex. blåmes och brukar blanda\n" +
        //         "ihop blåmes och talgoxe, så dyker även talgoxe upp som förslag\n" +
        //         "\"Undvik arter du redan kan\": Då dyker bara de arter som du ofta gissar fel på upp som förslag\n\n" +

        //         "Vill du spara dina framsteg?\n" +
        //         "- Klicka på \"Spara\"-knappen i högra kolumnen, längst ned\n" +
        //         "- Nästa gång du börjar träna kan du hämta tillbaka uppgifterna med \"Hämta\"-knappen\n\n" +

        //         "🎧 Ljud: xeno-canto    🖼️ Bilder: Pixabay" +
        //         ""
        //     );
        // }

        function showInfoAlert() {
            showCustomAlert(`
                <div style="text-align: left;">
                    <h3>🕊️ Träna fågelsång</h3>

                    <strong>🔹 Välj ut arter</strong>
                    <ul>
                        <li>Börja i kolumnen till vänster och skriv t.ex. "hackspett", "sylvia" eller "strand"</li>
                        <li>Ett antal förslag visas – Klicka ur de du inte vill träna på</li>
                        <li>Klicka på "Spara"-knappen</li>
                    </ul>

                    <strong>🔹 Träna</strong>
                    <ul>
                        <li>Klicka på "Träna på nytt läte"</li>
                        <li>Använd ledtrådar för att minnas bättre</li>
                        <li>Återställ med knappen: ↺</li>
                    </ul>

                    <strong>🔹 När du tränat ett tag</strong>
                    <ul>
                        <li><strong><em>Inkludera förväxlingsarter:</em></strong> söker du t.ex. blåmes och brukar blanda ihop <br> blåmes och talgoxe, så dyker även talgoxe upp som förslag</li>
                        <li><strong><em>Undvik arter du redan kan:</em></strong> bara arter du ofta gissar fel på visas</li>
                    </ul>

                    <strong>🔹 Vill du spara dina framsteg?</strong>
                    <ul>
                        <li>Klicka på "Spara"-knappen längst ned i högra kolumnen</li>
                        <li>Använd "Hämta"-knappen nästa gång</li>
                    </ul>

                    <p>
                        Synpunkter och idéer mottages tacksamt &nbsp;
                        <a href="javascript:void(0);" onclick="sendMail()">Skicka e-post</a>
                    </a>
                    </p>

                    <p>🎧 Ljud: xeno-canto     &nbsp;&nbsp;&nbsp;&nbsp;   🖼️ Bilder: Pixabay och iNaturalist</p>
                </div>
            `);
        }

        function sendMail() {
            const address = ['tranafagelsang', 'gmail', 'com'].join('@').replace('@', '.');
            window.location.href = `mailto:${address}?subject=Feedback%20från%20fågelsångssidan`;
        }


        function updateResultBar() {
            const bar = document.getElementById("resultBar");

            if (nbTries === 0) {
                bar.textContent = "";
                return;
            }

            const percent = Math.round((nbCorrect / nbTries) * 100);
            const totalBars = 10;
            const filled = Math.round(percent / 10);
            const empty = totalBars - filled;

            bar.textContent = `Resultat: ${"▓".repeat(filled)}${"░".repeat(empty)} ${nbCorrect}/${nbTries} rätt`; // (${percent}%)
        }

        function updateChart() {
            if (!progressChart) {
                const ctx = document.getElementById("progressChart").getContext("2d");
                progressChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: attemptLabels,
                        datasets: [{
                            label: `% rätt (senaste ${Math.min(guessHistory.length, 20)})`,
                            data: accuracyData,
                            borderColor: 'green',
                            backgroundColor: 'rgba(0,128,0,0.1)',
                            tension: 0.3,
                            fill: true,
                            pointRadius: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { display: false, position: 'top' } 
                        },
                        scales: {
                            y: {
                                min: 0,
                                max: 100,
                                ticks: { stepSize: 20 },
                                title: { display: true, text: "Träffsäkerhet (%)" }
                            },
                            x: {
                                title: { display: true, text: "Antal försök" }
                            }
                        }
                    }
                });
            }

            // Lägg bara till datapunkt om det finns försök
            if (guessHistory.length > 0) {
                const recent = guessHistory.slice(-maxGuessHistory);
                const percent = Math.round((recent.reduce((a, b) => a + b, 0) / recent.length) * 100);  //medel av recent

                accuracyData.push(percent);
                attemptLabels.push(nbTries.toString());

                if (accuracyData.length > maxGuessHistory) {
                    accuracyData.shift();
                    attemptLabels.shift();
                }
            
                progressChart.data.labels = attemptLabels;
                progressChart.data.datasets[0].data = accuracyData;

                // Dynamiskt uppdaterad etikett
                progressChart.data.datasets[0].label = `% rätt (senaste ${recent.length})`;
            }
            progressChart.update();
           
        }

        function resetGuessList() {
            guessList = [];
            currentSpecies = "";
            currentSpeciesSex = "";

            // Töm inputfält och resultat
            document.getElementById("guessInput").value = "";
            document.getElementById("guessResult").textContent = "";
            document.getElementById("guessResult").className = "guess-result";
            document.getElementById("resultSpecies").textContent = "";
            document.getElementById("loadingStatus").innerHTML = "";

            // Töm bild, ljud, ledtrådar
            document.getElementById("speciesImage").innerHTML = "";
            document.getElementById("audioPlayer").src = ""; // Stoppar ljud
            document.getElementById("clueText").textContent = "";
            document.getElementById("customClueInput").style.display = "none";

            // Töm gissningslistan visuellt
            document.getElementById("guessUL").innerHTML = "";

            uppdateraTräningsknappar();

        }

        function getSexSymbol(sex) {
            if (sex === "male") return "♂";
            if (sex === "female") return "♀";
            return "";
        }

        function addToSoundCache(species, recordings, typeKey) {
            if (!recordings || recordings.length === 0) return;

            const cacheKey = species + "_" + typeKey;

            if (soundCache[cacheKey]) {
                // Ta bort gamla positionen i kön
                const index = soundCacheOrder.indexOf(cacheKey);
                if (index !== -1) soundCacheOrder.splice(index, 1);
            }

            soundCache[cacheKey] = recordings;
            soundCacheOrder.push(cacheKey); //Lägg till sist i kön

            if (soundCacheOrder.length > maxCacheSize) {
                const oldestSpecies = soundCacheOrder.shift(); // Ta bort första
                delete soundCache[oldestSpecies];
            }
            //console.log("Cache:", soundCache);
        }

        function trackSearch(query) {
            if (!query) return;
            searchHistory.push(query);
        }

        function getSelectedSoundTypes() {
            const selected = document.querySelectorAll('#soundTags .tag-button.selected');
            return Array.from(selected).map(btn => btn.dataset.type);
        }

        function showCustomAlert(message) {
            const alertBox = document.getElementById("customAlert");
            const alertText = document.getElementById("customAlertText");
            const okButton = alertBox.querySelector("button"); // hitta OK-knappen

            alertText.innerHTML = message;
            alertBox.style.display = "block";

            okButton.focus(); // 🔍 sätt fokus på knappen
        }

        function hideCustomAlert() {
            document.getElementById("customAlert").style.display = "none";
        }

        function visaArtgruppStatistik() {
            const grupperAttVisa = ["mesar", "sparvar", "trastar", "gäss", "änder", "alkor", "finkar", "kråkor", "höns", "vadare", "måsar", "rovfåglar", "ugglor", "hackspettar", "sångare", "flugsnappare"]; // justera efter behov
            const statistik = [];

            grupperAttVisa.forEach(grupp => {
                const arter = artgrupper[grupp];
                if (!arter) return;

                let totalTries = 0;
                let totalCorrect = 0;

                arter.forEach(svName => {
                    for (const latinName in birdFacts) {
                        const fakta = birdFacts[latinName];
                        if (fakta.name === svName) {
                            totalTries += fakta.nbTries || 0;
                            totalCorrect += fakta.nbCorrect || 0;
                        }
                    }
                });

                if (totalTries > 0) {
                    const procent = Math.round((totalCorrect / totalTries) * 100);
                    statistik.push({
                        grupp,
                        procent,
                        totalTries,
                        totalCorrect
                    });
                }
            });

            if (statistik.length === 0) {
                let html = "<table style='font-size: 0.9em; border-collapse: collapse;'>"
                        //+ "<tr><td style='height: 1.5em;'>&nbsp;</td></tr>"
                        + "</table>";
                document.getElementById("groupStats").innerHTML = html;
                return;
            }

            // Sortera i fallande ordning efter % rätt
            statistik.sort((a, b) => b.procent - a.procent);

            // Bygg HTML-tabellen
            let html = "<table style='font-size: 0.9em; border-collapse: collapse;'>";

            statistik.forEach(row => {
                html += `<tr>
                    <td style="padding-left: 30px; padding-right: 10px; font-size: 1em; ">
                        ${row.grupp.charAt(0).toUpperCase() + row.grupp.slice(1)}
                    </td>
                    <td style="padding-right: 10px; font-size: 0.85em;">${row.procent}%</td>
                    <td style="font-size: 0.85em;">efter ${row.totalTries} försök</td>
                </tr>`;
            });

            html += "</table>";
            document.getElementById("groupStats").innerHTML = html;
        }

        function uppdateraTräningsknappar() {
            const aktiv = guessList.length > 0;

            document.getElementById("trainButtons").style.display = "flex";
            document.getElementById("clueButtons").style.display = "block";
            document.getElementById("guessing").style.display = "flex";

            document.getElementById("playButton").disabled = !aktiv;
            document.getElementById("clueButton").disabled = !aktiv;
            const guessInput = document.getElementById("guessInput");
            guessInput.disabled = !aktiv;
            guessInput.title = aktiv ? "Skriv en art eller klicka i listan" : "";
        }


    </script>
</body>
</html>
