<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tr√§na f√•gels√•ng</title> <!-- üê¶ -->
    <link rel="stylesheet" href="style.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
    <link rel="icon" href="favicon_TF.ico" type="image/x-icon">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="header-container">
        <h1 class="page-title">Tr√§na f√•gels√•ng</h1>
    </div>
    
    <div class="container">
        <div class="filters">
            
            <div><input type="checkbox" id="includeConfusion" class="custom-checkbox" /> Inkludera f√∂rv√§xlingsarter</div>
            <div><input type="checkbox" id="excludeSure" class="custom-checkbox" /> Undvik arter du redan kan</div>
            <div> 
                <input type="checkbox" id="songonly" class="custom-checkbox" checked /> 
                Spela bara s√•ngl√§ten
                <span class="songTooltip">
                    <i class="fas fa-info-circle info-icon"></i>
                    <span class="songTooltiptext">
                        Kryssa i om du vill slippa korta varningsl√§ten etc.<br>
                        Observera att vissa f√•glar inte har s√•ngl√§ten.
                        <span class="tooltipArrow"></span>
                    </span>
                </span>
            </div>
              
            <div style="margin-top: 30px;"></div>  <!-- Extra utrymme -->
            <div style="display: flex; align-items: center;">
                <input type="text" id="speciesInput" placeholder="S√∂k arter att tr√§na p√•" style="flex: 1;">
                <button id="resetButton" title="√Öterst√§ll" style="margin-left: 10px;">
                    <i class="fas fa-sync-alt"></i>  <!-- Ikon f√∂r √•terst√§llning -->
                </button>
            </div>

            <input type="text" name="email_check" style="display: none;"> <!-- honeypot -->
                       
            <div><p id="trainList"></p></div>
        </div>

        <div class="mitt">
            <div><audio id="audioPlayer" controls></audio></div> 
            <div style="margin-top: 10px;"></div>  <!-- Extra utrymme -->
           
            <div style="display: flex; justify-content: center; align-items: center; gap: 10px; margin-top: 10px;">
                <button onclick="playRandomBird()">Tr√§na p√• nytt l√§te</button>
                <span id="loadingStatus" style="font-size: 1em;"></span>
            </div>


            <div style="margin-top: 30px;"></div>  <!-- Extra utrymme -->
            <div>
                <button onclick="showClue()">Ledtr√•d</button>
            </div>
            <div>
                <p id="clueText"></p> <!-- Visar ledtr√•den -->
                <input type="text" id="customClueInput" placeholder="Skriv en egen ledtr√•d..." style="display:none;">
            </div>
            <div style="margin-top: 20px;"></div>  
            <div id="guessResult" class="guess-result"></div> 
            <div style="margin-top: 10px;"></div>  <!-- Extra utrymme -->
            <div id="speciesImage"></div>
            <!--<div style="margin-top: 10px;"></div>   Extra utrymme -->
            <div id="resultSpecies" class="result-species"></div>

            <!-- <div style="display: flex; align-items: center; margin-top: 5px;">  -->
            <div style="display: flex; align-items: baseline; margin-top: 5px;">
                <input type="text" id="guessInput"
                    onkeyup="dropDown()"
                    placeholder="Gissa..."
                    title="Skriv ett namn"
                    style="flex: 1; height: 28px; font-size: 13px; padding: 4px 8px;">             
                <button id="resetGuessButton" title="Rensa gissningslista" style="margin-left: 10px;">
                  <i class="fas fa-sync-alt"></i>
                </button>

            </div>
            <div style="margin-top: 5px;"></div>
            <ul id="guessUL"></ul> <!-- Dynamisk lista -->
        </div>

        <div class="statistics">
            <div>
                <p><strong style="font-size: 0.9em;">Statistik</strong></p>
                <div style="margin-top: 10px;"></div>  <!-- Extra utrymme -->
            </div>
            <div id="resultBar" style="margin-top: 10px; font-size: 0.9em;"></div>
            <!-- <div><p>Antal gissningar: <span id="nbTries">0</span></p></div>
            <div><p>Antal korrekta svar: <span id="nbCorrect">0</span></p></div> -->
            <div id="streakContainer" style="display: none;"> <!-- Dold fr√•n b√∂rjan -->
                <p style="font-size: 0.9em;">Antal r√§tt i rad: <span id="nbInRow">0</span></p>
            </div>
            <div style="margin-top: 10px;"></div>  <!-- Extra utrymme -->
            <canvas id="progressChart" width="300" height="150" style="margin-top: 20px;"></canvas>
            <div style="margin-top: 10px;"></div>  <!-- Extra utrymme -->
            <div>
                <p><strong style="font-size: 0.9em;">H√§mta eller spara din data</strong></p>
                <input type="file" id="uploadFileInput" accept=".json" />
                <div style="margin-top: 10px;"></div>  <!-- Extra utrymme -->
            </div>
            <div>
                <div style="margin-top: 20px;"></div>  <!-- Extra utrymme -->
                <button onclick="downloadBirdFacts()">Spara till dator</button>
            </div>
            <div style="margin-top: 20px;"></div>  <!-- Extra utrymme -->
            <div style="margin-top: 40px; text-align: center;">
                <button onclick="showInfoAlert()">‚Ñπ</button>
            </div>
        </div>
    </div>

    <footer style="text-align: center; margin-top: 40px; font-size: 0.85em; opacity: 0.7;">
        <a href="https://www.freecounterstat.com" target="_blank" title="Page counter">
          <img src="https://counter4.optistats.ovh/private/freecounterstat.php?c=nkcezkqp3d8nx5scumkwlsas73l7htgp" border="0" alt="Page counter" />
        </a>
    </footer>

    <script>
        let currentSpecies = ""; // aktuell art , Latinskt namn
        let currentSpeciesSex = "";
        let nbTries = 0;
        let nbCorrect = 0;
        let streakCount= 0;
        
        let birdFacts = {};
        let artgrupper = {};
        let trainList = [];
        let guessList = [];
        let birdImageList = [];

        let progressChart;
        let accuracyData = [];
        let attemptLabels = [];

        async function loadBirdImages() {
            const response = await fetch('birdImages.json');
            birdImageList = await response.json();
        }

        async function loadBirdFacts() {
            const response = await fetch('birdFacts.json'); 
            const temp = await response.json();
            birdFacts = temp;
        }
        
         async function loadArtgrupper() {
            const response = await fetch('artgrupper.json'); 
            artgrupper = await response.json(); 
        }

        async function init() {
            await Promise.all([
                loadBirdFacts(),
                loadArtgrupper(),
                loadBirdImages()
            ]);
            console.log("BirdFacts:", birdFacts);
            console.log("Artgrupper:", artgrupper);
           //console.log("birdImageList:", birdImageList);

            updateResultBar();
        }

        init();


        document.getElementById("resetButton").addEventListener("click", resetLists); //Reset
        document.getElementById("resetGuessButton").addEventListener("click", resetGuessList);

        document.addEventListener("DOMContentLoaded", function() {
                document.getElementById("guessUL").addEventListener("click", function(e) {
                    if (e.target && e.target.tagName === "A") {
                        e.preventDefault();
                        const selectedGuess = e.target.textContent;

                        document.getElementById("guessInput").value = selectedGuess;
                    }
                });
            });
        
        document.getElementById("speciesInput").addEventListener("keydown", function(event) {
            if (event.key === "Enter") {  // Kollar om anv√§ndaren trycker p√• Enter i √§ndra tr√§ningslista
                event.preventDefault();
                findTrainList();
            }
        });

        document.getElementById('customClueInput').addEventListener('keydown', function(event) {
            if (event.key === 'Enter') {  // Kollar om anv√§ndaren trycker p√• Enter i Ledtr√•d
                updateClue(); 
            }
        });

        document.getElementById("uploadFileInput").addEventListener("change", function () {
            loadBirdFactsFromFile(); // Ladda filen direkt n√§r den v√§ljs
        });

        function resetLists() {
            trainList = [];
            guessList = [];
            document.getElementById("speciesInput").value = "";
            document.getElementById("trainList").innerHTML = "";
            document.getElementById("guessResult").textContent = "";
            document.getElementById("guessResult").className = "guess-result";
            document.getElementById("clueText").textContent = "";
            document.getElementById("customClueInput").style.display = "none";
            document.getElementById("guessInput").value = "";
            document.getElementById("speciesImage").innerHTML = "";
            document.getElementById("resultSpecies").textContent = "";
            document.getElementById("audioPlayer").src = ""; // Stoppar ljudet
                                
            populateGuessList(); 
        }
                
        async function findTrainList() {
            const query = document.getElementById('speciesInput').value.toLowerCase().trim();
            const listDiv = document.getElementById('trainList');
            const includeConfusionCheckbox = document.getElementById("includeConfusion");
            let artgrupphittad = false;

            listDiv.innerHTML = ""; // Rensa tidigare resultat
            trainList = [];  

            if (!await shouldAllowSearch(query)) return;
            

            if (!birdFacts || Object.keys(birdFacts).length === 0) {
                console.error("‚ùå birdFacts √§r inte laddad eller tom!");
                return;
            }

            const normalize = str => str.trim().toLowerCase().replace(/\s+/g, ' ');
            const foundKey = Object.keys(artgrupper).find(key => normalize(key) === normalize(query));            
            console.log("foundKey",foundKey,"query",query);

            if (foundKey) {
                const speciesList = artgrupper[foundKey]; // Lista med svenska artnamn

                for (const swedishName of speciesList) {
                    // Sl√• upp latinskt namn via birdFacts
                    const latinName = Object.keys(birdFacts).find(
                        key => birdFacts[key].name === swedishName
                    );

                    if (latinName) {
                        trainList.push({ latin: latinName, swedish: swedishName });
                    } else {
                        console.warn(`‚ö†Ô∏è Hittade inte latinskt namn f√∂r: ${swedishName}`);
                    }
                }

                artgrupphittad = true;
            }


            if (!artgrupphittad) {
                        // G√• igenom birdFacts och leta efter matchning
                for (const latinName in birdFacts) {
                    if (!birdFacts[latinName] || !birdFacts[latinName].name) {
                        console.warn(`‚ö†Ô∏è Saknad 'name' f√∂r: ${latinName}`);
                        continue;  // Hoppa √∂ver om det saknas
                    }

                    const swedishName = birdFacts[latinName].name.toLowerCase();
                    const latinNameLower = latinName.toLowerCase();

                    if (latinNameLower.includes(query) || swedishName.includes(query)) {
                        trainList.push({ latin: latinName, swedish: birdFacts[latinName].name });
                    }
                }
            }
                             // Om includeConfusion √§r ikryssad, l√§gg till f√∂rv√§xlingsarter
            if (includeConfusionCheckbox.checked) {
                    const confusionSpecies = new Set();

                    trainList.forEach(species => {
                        const confusionList = birdFacts[species.latin]?.confusionSpecies;
                        if (confusionList && Array.isArray(confusionList)) {
                            confusionList.forEach(confusionLatin => {
                                if (!trainList.some(s => s.latin === confusionLatin) && birdFacts[confusionLatin]) {
                                    confusionSpecies.add(confusionLatin);
                                }
                            });
                        }
                    });

                    // L√§gg till de nya f√∂rv√§xlingsarterna i trainList
                    confusionSpecies.forEach(latinName => {
                        trainList.push({ latin: latinName, swedish: birdFacts[latinName].name });
                    });
                }

            if (trainList.length === 0) {
                listDiv.innerHTML = "<p>Inga matchningar hittades.</p>";
                return;
            }

           // Skapa en lista med checkboxes
            const excludeSureCheckbox = document.getElementById("excludeSure");
            const form = document.createElement("form");
            form.id = "trainListForm";

            trainList.forEach(species => {
                const label = document.createElement("label");
                label.style.display = "block";

                const checkbox = document.createElement("input");
                checkbox.type = "checkbox";
                checkbox.value = species.latin;
                checkbox.checked = true;
                checkbox.className = "custom-checkbox";

                label.appendChild(checkbox);

                label.innerHTML += ` ${species.swedish} <i style="font-size: 0.8em;">${species.latin}</i>`;
                label.style.fontSize = "0.9em"; // Svenska textens storlek

                form.appendChild(label);
            });

            listDiv.appendChild(form);

            setTimeout(() => {
                document.querySelectorAll("#trainListForm input[type=checkbox]").forEach(checkbox => {
                    const species = trainList.find(s => s.latin === checkbox.value); // Hitta arten
                    
                    if (species && excludeSureCheckbox.checked && birdFacts[species.latin]?.nbTries > 0) {
                        const nbCorr = birdFacts[species.latin].nbCorrect;
                        const nb = birdFacts[species.latin].nbTries; 
                        checkbox.checked = nbCorr < 0.5 * nb;
                    } else {
                        checkbox.checked = true;
                    }
                });
            }, 0);

            // Skapa och l√§gg till "Spara s√∂klistan"-knappen
            const saveButton = document.createElement("button");
            saveButton.textContent = "Spara till tr√§ningslistan";
            saveButton.onclick = saveGuessList;
            saveButton.className = "green-button";
            saveButton.style.marginTop = "10px";
            listDiv.appendChild(saveButton);
            
        }

        async function shouldAllowSearch(query) {
            if (!query) return false;

            const honeypot = document.querySelector('input[name="email_check"]');
            if (honeypot && honeypot.value !== "") {
                console.warn("üï∑Ô∏è M√∂jlig bot uppt√§ckt via honeypot!");
                return false;
            }

            const now = Date.now();
            window.lastSearchTime = window.lastSearchTime || 0;

            const timeSinceLast = now - window.lastSearchTime;
            if (timeSinceLast < 1000) {
                const delay = 1000 - timeSinceLast;
                //console.log(`‚è±Ô∏è V√§ntar ${delay} ms p.g.a. tidsgr√§ns`);
                await new Promise(resolve => setTimeout(resolve, delay));
            }

            window.lastSearchTime = Date.now();
            return true;
        }



        // Sparar de icheckade arterna i guessList
        function saveGuessList() {
            
            const checkboxes = document.querySelectorAll("#trainListForm input[type='checkbox']:checked");

            checkboxes.forEach(checkbox => {
                if (!guessList.includes(checkbox.value)) {  // Kontrollera om arten redan finns
                    guessList.push(checkbox.value);
                }
            });

            document.getElementById("speciesInput").value = "";
            populateGuessList();
            updateResultBar()
        }

        async function playRandomBird() {
            document.getElementById("guessResult").textContent = "";
            document.getElementById("guessResult").className = "guess-result";
            document.getElementById('clueText').textContent = ""; // suddar ev tidigare clue
            document.getElementById('customClueInput').style.display = "none"; // D√∂lj inmatningsf√§ltet
            document.getElementById('guessInput').value = ""
            document.getElementById('speciesImage').innerHTML = "";
            document.getElementById('resultSpecies').textContent = "";
            
            if (!guessList || guessList.length === 0) { 
                alert("V√§lj arter att tr√§na p√•")
                return; 
            }
            document.getElementById("loadingStatus").innerHTML = `<span class="spinner"></span>`;
            
            
            currentSpecies = guessList[Math.floor(Math.random() * guessList.length)]; // Ex: "Parus major"
            const songOnly = document.getElementById('songonly').checked;

            try {
                const randomRecording = await fetchRecording(currentSpecies, songOnly);
                
                if (!randomRecording) {
                    alert("Inga ljudinspelningar hittades. Testa att avmarkera 'Spela bara s√•ngl√§ten'");
                    return;
                }
                currentSpeciesSex = randomRecording.sex
                
                document.getElementById("audioPlayer").oncanplay = () => {
                    const xcId = `XC${randomRecording.id}`;
                    const recordist = randomRecording.rec || "ok√§nd inspelare";

                    document.getElementById("loadingStatus").innerHTML = `
                        <span title="${xcId} ‚Äì ${recordist}" style="cursor: default;">üîä</span>`;
                };
                // spela upp ljudet
                document.getElementById('audioPlayer').src = randomRecording.file;  // Ljudfilens URL
                document.getElementById('audioPlayer').play();
            } catch (error) {
                console.error("Fel vid h√§mtning av ljudfil:", error);
                document.getElementById("loadingStatus").innerHTML = `‚ö†Ô∏è Ingen ljudfil.`;
            }
        }

        async function fetchRecording(currentSpecies, songOnly) {
            const speciesOverride = {
                "Corvus monedula": "Coloeus monedula",
                "Loxia bifasciata": "Loxia leucoptera"
            };
            const lookupSpecies = speciesOverride[currentSpecies] || currentSpecies;

            const countries = ["sweden", "norway", "finland", "estonia"];
            const minAntal = 15;
            let allRecordings = [];

            for (const country of countries) {
                let query = `grp:birds+cnt:${country}+${lookupSpecies}`;
                if (songOnly) query += "+type:song";

                const response = await fetch(`https://xeno-canto.org/api/2/recordings?query=${query}`);
                const data = await response.json();

                if (data.recordings?.length > 0) {
                    allRecordings = allRecordings.concat(data.recordings);
                    console.log(`‚ûï Lade till ${data.recordings.length} fr√•n ${country}`);
                }

                if (allRecordings.length >= minAntal) break;
            }

            if (allRecordings.length < minAntal) {
                let query = `grp:birds+${lookupSpecies}`;
                if (songOnly) query += "+type:song";

                const response = await fetch(`https://xeno-canto.org/api/2/recordings?query=${query}`);
                const data = await response.json();

                if (data.recordings?.length > 0) {
                    allRecordings = allRecordings.concat(data.recordings);
                    console.log(`üåç Lade till ${data.recordings.length} globala inspelningar`);
                }
            }

            if (allRecordings.length === 0) {
                console.warn("‚ö†Ô∏è Inga inspelningar hittades.");
                return null;
            }

            // üéØ Slumpa en av inspelningarna
            const randomRecording = allRecordings[Math.floor(Math.random() * allRecordings.length)];
            return randomRecording;
        }


        function populateGuessList() {
            const ul = document.getElementById("guessUL");
            ul.innerHTML = ""; // Rensa listan

            guessList.forEach(species => {
                const li = document.createElement("li");
                const a = document.createElement("a");
                a.href = "#";
                a.textContent = birdFacts[species].name;
                a.onclick = function() {
                    showGuessResult(species,birdFacts[species].name); // Uppdatera guessResult
                };
                li.appendChild(a);
                ul.appendChild(li);
            });
        }

        function dropDown() {
            const input = document.getElementById("guessInput");
            const filter = input.value.toUpperCase();
            const ul = document.getElementById("guessUL");
            const li = ul.getElementsByTagName("li");

            for (let i = 0; i < li.length; i++) {
                const txtValue = li[i].textContent || li[i].innerText;
                li[i].style.display = txtValue.toUpperCase().includes(filter) ? "" : "none";
            }
        }


        async function showGuessResult(speciesLat, speciesSV) {
            const resultDiv = document.getElementById("guessResult");
            const resultSpeciesDiv = document.getElementById("resultSpecies");
            const imageDiv = document.getElementById("speciesImage"); 
            let responseText;

            const isCorrect = speciesLat.toLowerCase() === currentSpecies.toLowerCase();

            nbTries += 1;
            birdFacts[currentSpecies].nbTries += 1;

            if (isCorrect) {
                const correctResponses = [
                    `üçÄ R√§tt!`,
                    `üçÄ Bra jobbat!`,
                    `üçÄ Exakt!`,
                    `üçÄ Helt r√§tt!`,
                    `üçÄ Snyggt!`,
                    `üçÄ Du har koll p√•`
                ];
                responseText = correctResponses[Math.floor(Math.random() * correctResponses.length)];
                nbCorrect += 1;
                birdFacts[currentSpecies].nbCorrect += 1;
                streakCount += 1;
            } else {
                const incorrectResponses = [
                    `‚ùå Fel!`,
                    `‚ùå Inte riktigt!`,
                    `‚ùå N√§stan!`,
                    `‚ùå Ojd√•!`,
                    `‚ùå B√§ttre lycka n√§sta g√•ng!`
                ];
                responseText = incorrectResponses[Math.floor(Math.random() * incorrectResponses.length)];
                streakCount = 0;
                if (!birdFacts[currentSpecies].confusionSpecies.includes(speciesLat)) {
                    birdFacts[currentSpecies].confusionSpecies.push(speciesLat);
                    if (birdFacts[currentSpecies].confusionSpecies.length > 4) {
                        birdFacts[currentSpecies].confusionSpecies.shift(); // tar bort den √§ldsta f√∂rv√§xlingsarten
                    }
                    //console.log("lagt till f√∂rv√§xlingsart: ", birdFacts[currentSpecies].confusionSpecies)
                }
                
            }

            updateResultBar()
            updateChart();
            resultDiv.textContent = responseText;
          
            await showSpeciesImage(birdFacts[currentSpecies].name);

            // document.getElementById('nbTries').textContent = nbTries;
            // document.getElementById('nbCorrect').textContent = nbCorrect;
            const streakContainer = document.getElementById("streakContainer");
            if (streakCount > 4) {
                streakContainer.style.display = "block"; // Visa om > 5
                document.getElementById('nbInRow').textContent = streakCount;
            } else {
                streakContainer.style.display = "none"; // D√∂lj annars
            }
            resultSpeciesDiv.innerHTML = `${birdFacts[currentSpecies].name} <em>${currentSpecies}</em> ${getSexSymbol(currentSpeciesSex)}`;  // Artnamn under bild Latinskt namn i kursiv stil

            document.getElementById('guessInput').value = "" //nollst√§ll gissa-rutan
            dropDown();
        }

        async function showSpeciesImage(svName) {
            const imageDiv = document.getElementById('speciesImage');

            // 1. Leta efter matchande lokal bild i birdImageList
            function escapeRegex(str) {
                return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); // skydda specialtecken
            }

            const safeSvName = escapeRegex(svName.trim());
            const regex = new RegExp(`(^|[^a-z√•√§√∂A-Z√Ö√Ñ√ñ])${safeSvName}([^a-z√•√§√∂A-Z√Ö√Ñ√ñ]|$)`, 'i');

            const matchingLocal = birdImageList.filter(filename => {
                const name = filename.replace(/\.[^/.]+$/, ""); // ta bort fil√§ndelse
                return regex.test(name);
            });


            // const matchingLocal = birdImageList.filter(filename =>
            //     filename.toLowerCase().includes(svName.toLowerCase())
            // );

            if (matchingLocal.length > 0) {
                const randomLocal = matchingLocal[Math.floor(Math.random() * matchingLocal.length)];
                const localUrl = `birdPicts/${randomLocal}`;
                imageDiv.innerHTML = `<img src="${localUrl}" alt="${svName}" style="max-width: 200px; border-radius: 10px;">`;
                return;
            }

            // 2. Om ingen lokal bild hittades, h√§mta fr√•n webben
            const imageUrl = await fetchRandomImage(svName);

            if (imageUrl) {
                imageDiv.innerHTML = `<img src="${imageUrl}" alt="${svName}" style="max-width: 200px; border-radius: 10px;">`;
            } else {
                imageDiv.innerHTML = "<p>Ingen bild tillg√§nglig.</p>";
            }
        }

        async function fetchRandomImage(speciesSV) {
            const API_KEY = "49566155-8922f41ce0098cddb78eed458"
            const query = encodeURIComponent(speciesSV); 
            const url = `https://pixabay.com/api/?key=${API_KEY}&q=${query}&lang=sv&image_type=photo&safesearch=true&per_page=10`;

            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error("Misslyckades med att h√§mta bilder fr√•n Pixabay");
                }
                
                const data = await response.json();
                
                const exactMatch = data.hits.filter(img => {
                    return img.tags.toLowerCase().split(", ").some(tag => tag.includes(speciesSV.toLowerCase()));
                });
                
                if (exactMatch.length > 0) {
                    const randomImage = exactMatch[Math.floor(Math.random() * exactMatch.length)];
                    return randomImage.previewURL; // Eller randomImage.webformatURL f√∂r st√∂rre bild
                } else {
                    //console.warn("Inga bilder hittades f√∂r s√∂kningen:", speciesSV);
                    return null;
                }
            } catch (error) {
                console.error("Fel vid h√§mtning av bild:", error);
                return null;
            }
        }


        async function showClue() {
            const clueText = document.getElementById('clueText');
            const customClueInput = document.getElementById('customClueInput');
            customClueInput.value = ""
            
            if (!currentSpecies) {
                clueText.textContent = "L√§gg till arter f√∂rst!";
                return;
            }

            // visa ledtr√•d
            const speciesInfo = birdFacts[currentSpecies];
            if (speciesInfo && speciesInfo.clue) {
                clueText.textContent = speciesInfo.clue;  // Visa den lagrade ledtr√•den fr√•n birdFacts
            } else {
                clueText.textContent = "Ingen ledtr√•d tillg√§nglig."; 
            }
                
            customClueInput.style.display = "inline-block"; // Visa inmatningsf√§ltet f√∂r ny ledtr√•d
        }

        async function updateClue() {
            const customClueInput = document.getElementById('customClueInput').value.trim();

            if (!currentSpecies || !customClueInput) { return; }

            if (birdFacts[currentSpecies]) { birdFacts[currentSpecies].clue = customClueInput; }
            document.getElementById('clueText').textContent = `Ledtr√•d uppdaterad: ${customClueInput}`;              
        }

        function loadBirdFactsFromFile() {
            const fileInput = document.getElementById("uploadFileInput");
            const file = fileInput.files[0]; // H√§mta den valda filen

            if (!file) {
                alert("V√§lj en fil f√∂rst!");
                return;
            }

            const reader = new FileReader();
            reader.onload = async function (event) {
                try {
                    birdFacts = JSON.parse(event.target.result); // Spara inneh√•llet i variabeln
                    alert("Fil med f√•geldata har laddats in!");
                } catch (error) {
                    alert("Fel vid inl√§sning av JSON-filen.");
                    console.error("JSON-parse-fel:", error);
                }
            };

            reader.readAsText(file); // L√§s in filen som text
        }

        function downloadBirdFacts() {
            const dataStr = JSON.stringify(birdFacts, null, 2); // Format med indrag
            const blob = new Blob([dataStr], { type: "application/json" });
            const url = URL.createObjectURL(blob);

            const link = document.createElement("a");
            link.href = url;
            link.download = "birdFacts.json";
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            URL.revokeObjectURL(url); // Rensa tempor√§r URL
        }

        function showInfoAlert() {
            alert(
                "üïäÔ∏è Tr√§na f√•gels√•ng\n\n" +
                "Lyssna p√• f√•gell√§ten och gissa vilken art det √§r.\n" +
                "Du kan v√§lja ut arter att tr√§na p√• \n" + 
                "Du kan visa ledtr√•dar och skriva in dina egna. \n" +  
                "Du kan spara din statistik och h√§mta den igen n√§sta g√•ng.\n\n" +
                "üéß Ljud: xeno-canto\nüñºÔ∏è Bilder: Pixabay\n" +
                ""
            );
        }

        function updateResultBar() {
            const bar = document.getElementById("resultBar");

            if (nbTries === 0) {
                bar.textContent = "Inga f√∂rs√∂k √§nnu."; // üéØ
                return;
            }

            const percent = Math.round((nbCorrect / nbTries) * 100);
            const totalBars = 10;
            const filled = Math.round(percent / 10);
            const empty = totalBars - filled;

            bar.textContent = `Resultat: ${"‚ñì".repeat(filled)}${"‚ñë".repeat(empty)} ${nbCorrect}/${nbTries} r√§tt`; // (${percent}%)
        }

        function updateChart() {
            if (nbTries === 0) return;

            const percent = Math.round((nbCorrect / nbTries) * 100);
            accuracyData.push(percent);
            attemptLabels.push(nbTries.toString());
            if (accuracyData.length > 20) {
                accuracyData.shift();
                attemptLabels.shift();
            }

            if (!progressChart) {
                const ctx = document.getElementById("progressChart").getContext("2d");
                progressChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: attemptLabels,
                        datasets: [{
                            label: '% r√§tt',
                            data: accuracyData,
                            borderColor: 'green',
                            backgroundColor: 'rgba(0,128,0,0.1)',
                            tension: 0.3,
                            fill: true,
                            pointRadius: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: {
                                min: 0,
                                max: 100,
                                ticks: { stepSize: 20 },
                                title: { display: true, text: "Tr√§ffs√§kerhet (%)" }
                            },
                            x: {
                                title: { display: true, text: "Antal f√∂rs√∂k" }
                            }
                        }
                    }
                });
            } else {
                progressChart.data.labels = attemptLabels;
                progressChart.data.datasets[0].data = accuracyData;
                progressChart.update();
            }
        }

        function resetGuessList() {
            guessList = [];
            currentSpecies = "";
            currentSpeciesSex = "";

            // T√∂m inputf√§lt och resultat
            document.getElementById("guessInput").value = "";
            document.getElementById("guessResult").textContent = "";
            document.getElementById("guessResult").className = "guess-result";
            document.getElementById("resultSpecies").textContent = "";

            // T√∂m bild, ljud, ledtr√•dar
            document.getElementById("speciesImage").innerHTML = "";
            document.getElementById("audioPlayer").src = ""; // Stoppar ljud
            document.getElementById("clueText").textContent = "";
            document.getElementById("customClueInput").style.display = "none";

            // T√∂m gissningslistan visuellt
            document.getElementById("guessUL").innerHTML = "";

        }

        function getSexSymbol(sex) {
            if (sex === "male") return "‚ôÇ";
            if (sex === "female") return "‚ôÄ";
            return "";
        }

    </script>
</body>
</html>
